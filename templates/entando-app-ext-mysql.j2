#---
#apiVersion: v1
#kind: PersistentVolumeClaim
#metadata:
#  name: mysql8
#spec:
#  accessModes:
#    - ReadWriteOnce
#  resources:
#    requests:
#      storage: 1Gi

#---
#kind: Deployment
#apiVersion: apps/v1
#metadata:
#  annotations:
#  name: entando-mysql-rocky
#spec:
#  replicas: 1
#  selector:
#    matchLabels:
#      app: entando-mysql-rocky
#  template:
#    metadata:
#      labels:
#        app: entando-mysql-rocky
#        deploymentconfig: entando-mysql-rocky
#    spec:
#      volumes:
#        - name: mysql8
#          persistentVolumeClaim:
#            claimName: mysql8
#      containers:
#        - resources: {}
#          name: entando-mysql-rocky
#          image: docker.io/entando/entando-mysql-rocky:8.0.28
#          ports:
#            - containerPort: 3306
#              protocol: TCP
#            - containerPort: 33060
#              protocol: TCP
#            - containerPort: 33061
#              protocol: TCP
#          volumeMounts:
#            - name: mysql8
#              mountPath: /var/lib/mysql/data
#          envFrom:
#            - secretRef:
#                name: mysql-cred
#      securityContext: {}
#      schedulerName: default-scheduler
---
apiVersion: entando.org/v1
kind: EntandoDatabaseService
metadata:
  namespace: {{ namespace }}
  name: {{ appname }}-database-service
  annotations:
    entando.org/processing-instruction: defer
spec:
  provisioningStrategy: UseExternal
  port: 32528
  dbms: mysql
  host: 20.79.239.35
  providedCapabilityScope: Namespace
  secretName: mysql-secret
---
apiVersion: entando.org/v1
kind: EntandoApp
metadata:
 name: {{ appname }}
annotations:
  entando.org/processing-instruction: defer
replicas: 1
standardServerImage: eap
spec:
  dbms: mysql
  entandoAppVersion: "7.0"
  environmentVariables:
  - name: PORTDB_URL
    value: "jdbc:mysql://20.79.239.35:32528/automation_PORTuser"
  - name: PORTDB_USERNAME
    valueFrom:
      secretKeyRef:
       key: username
       name: {{appname}}-portdb-secret
       optional: false
  - name: PORTDB_PASSWORD
    valueFrom:
      secretKeyRef:
       key: password
       name: {{appname}}-portdb-secret
       optional: false
  - name: PORTDB_CONNECTION_CHECKER
    value: org.jboss.jca.adapters.jdbc.extensions.mysql.MySQLValidConnectionChecker
  - name: PORTDB_EXCEPTION_SORTER
    value: org.jboss.jca.adapters.jdbc.extensions.mysql.MySQLExceptionSorter
  - name: SERVDB_URL
    value: "jdbc:mysql://20.79.239.35:32528/automation_SERVuser"
  - name: SERVDB_USERNAME
    valueFrom:
      secretKeyRef:
       key: username
       name: {{appname}}-servdb-secret
       optional: false
  - name: SERVDB_PASSWORD
    valueFrom:
      secretKeyRef:
       key: password
       name: {{appname}}-servdb-secret
       optional: false
  - name: SERVDB_CONNECTION_CHECKER
    value: org.jboss.jca.adapters.jdbc.extensions.mysql.MySQLValidConnectionChecker
  - name: SERVDB_EXCEPTION_SORTER
    value: org.jboss.jca.adapters.jdbc.extensions.mysql.MySQLExceptionSorter
  - name: SPRING_DATASOURCE_URL
    value: "jdbc:mysql://20.79.239.35:32528/automation_DEuser"
  - name: SPRING_DATASOURCE_USERNAME
    valueFrom:
      secretKeyRef:
       key: username
       name: {{appname}}-dedb-secret
       optional: false
  - name: SPRING_DATASOURCE_PASSWORD
    valueFrom:
      secretKeyRef:
       key: password
       name: {{appname}}-dedb-secret
       optional: false
  ingressHostName: {{ appname }}.apps.{{ openshift_url }}