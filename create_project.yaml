---
 - hosts: AWX
   become: yes
   become_user: openshift
   tasks:
    - name: Login in
      command: chdir=/home/openshift ./oc login api.{{ openshift_url }}:6443 -u admin -p {{ password1 }} --insecure-skip-tls-verify=true

    - name: Create Project
      shell: ./oc create namespace {{ namespaces }}
      
    - name: Copy certificate-script Script
      template:
        src: ./templates/selfsign-certificate-script.js
        dest: selfsign-certificate-script.sh
 
    - name: Make script executable
      shell: chmod +x selfsign-certificate-script.sh

    - name: Run certificates script
      shell: ./selfsign-certificate-script.sh
      
    - name: Create secret
      shell: ./oc create secret tls entando-tls-secret --key="{{ appname }}.apps.{{ openshift_url }}-server-key.pem" --cert="{{ appname }}.apps.{{ openshift_url }}-server-cert.pem" -n {{ namespaces }}
    
    - name: Create ca secret
      shell: ./oc create secret generic entando-ca-cert-secret --from-file="{{ appname }}.apps.{{ openshift_url }}-ca-cert.pem" -n {{ namespaces }}
    
    - name: Remove certificates from host
      shell: rm  {{ appname }}.apps.{{ openshift_url }}*.pem

    - name: Copy operator-config
      template:
        src: ./templates/{{operatorconfig}}.j2
        dest: "{{operatorconfig}}.yaml"

    - name: Install operatorscript on namespace scope
      shell: ./oc apply -f "{{operatorconfig}}.yaml" -n {{ namespaces }}      

    - name: Copy Operator Script
      template:
        src: ./templates/entando-subscription.j2
        dest: entando-subscription.yaml

    - name: Install operatorscript on namespace scope
      shell: ./oc apply -f entando-subscription.yaml -n {{ namespaces }}

    - name: Copy Entando App Script
      template:
        src: ./templates/{{entandoappconfig}}.j2
        dest: "{{entandoappconfig}}.yaml"

    - name: Install Entando App on namespace scope
      shell: ./oc apply -f "{{entandoappconfig}}.yaml" -n {{ namespaces }}
