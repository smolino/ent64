---
 - hosts: AWX
   become: yes
   become_user: "{{ username }}"
   environment:
     - PATH: '{{ lookup(''env'', ''PATH'') }}:/home/{{ username }}/.local/bin/aws'
     - PATH: '{{ lookup(''env'', ''PATH'') }}:/home/{{ username }}/.entando/ent/v7.0.1/cli/v7.0.0/bin'
   tasks:
   
    - name: Select working dir
      command: cd /home/{{ username }}
      
    - name: Copy Bundle script Script
      template:
        src: ./templates/simple_bundle.j2
        dest: /home/{{ username }}/simple_bundle.yaml
        
    - name: Deploy bundle
      shell: chdir=/home/{{ username }} kubectl apply -f /home/{{ username }}/simple_bundle.yaml -n {{ namespace }}
      
    - name: Collect all Entando application logs with ent
      shell: |
          source /home/{{ username }}/.entando/activate --quiet --force 2>/dev/null
          ent namespace {{ namespace }}
          ent appname {{ appname }}
          ent ecr install --name app1
